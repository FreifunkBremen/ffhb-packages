<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no" />
<title>HTML5 Speedtest</title>
<style type="text/css">
	html,body{
		border:none; padding:0; margin:0;
		background:#FFFFFF;
		color:#202020;
	}
	body{
		text-align:center;
		font-family:"Roboto",sans-serif;
	}
	h1{
		color:#404040;
	}
	#startStopBtn{
		display:inline-block;
		margin:0 auto;
		color:#6060AA;
		background-color:rgba(0,0,0,0);
		border:0.15em solid #6060FF;
		border-radius:0.3em;
		transition:all 0.3s;
		box-sizing:border-box;
		width:8em; height:3em;
		line-height:2.7em;
		cursor:pointer;
		box-shadow: 0 0 0 rgba(0,0,0,0.1), inset 0 0 0 rgba(0,0,0,0.1);
	}
	#startStopBtn:hover{
		box-shadow: 0 0 2em rgba(0,0,0,0.1), inset 0 0 1em rgba(0,0,0,0.1);
	}
	#startStopBtn.running{
		background-color:#FF3030;
		border-color:#FF6060;
		color:#FFFFFF;
	}
	#startStopBtn:before{
		content:"Start";
	}
	#startStopBtn.running:before{
		content:"Abort";
	}
	#test{
		margin-top:2em;
		margin-bottom:12em;
	}
	div.testArea{
		display:inline-block;
		width:16em;
		height:12.5em;
		position:relative;
		box-sizing:border-box;
	}
	div.testName{
		position:absolute;
		top:0.1em; left:0;
		width:100%;
		font-size:1.4em;
		z-index:9;
	}
	div.meterText{
		position:absolute;
		bottom:1.55em; left:0;
		width:100%;
		font-size:2.5em;
		z-index:9;
	}
	div.meterText:empty:before{
		content:"0.00";
	}
	div.unit{
		position:absolute;
		bottom:2em; left:0;
		width:100%;
		z-index:9;
	}
	div.testArea canvas{
		position:absolute;
		top:0; left:0; width:100%; height:100%;
		z-index:1;
	}
	@media all and (max-width:65em){
		body{
			font-size:1.5vw;
		}
	}
	@media all and (max-width:40em){
		body{
			font-size:0.8em;
		}
	}

</style>
<script type="text/javascript">
function I(id){return document.getElementById(id);}

//CODE FOR GAUGES
var meterBk="#E0E0E0",
	dlColor="#6060AA";

function drawMeter(amount){
	var c = I('dlMeter');
	var ctx=c.getContext("2d");
	var dp=window.devicePixelRatio||1;
	var cw=c.clientWidth*dp, ch=c.clientHeight*dp;
	var sizScale=ch*0.0055;
	if(c.width==cw&&c.height==ch){
		ctx.clearRect(0,0,cw,ch);
	}else{
		c.width=cw;
		c.height=ch;
	}
	ctx.beginPath();
	ctx.strokeStyle=meterBk;
	ctx.lineWidth=16*sizScale;
	ctx.arc(c.width/2,c.height-58*sizScale,c.height/1.8-ctx.lineWidth,-Math.PI*1.1,Math.PI*0.1);
	ctx.stroke();
	if(0.0 != amount){
		ctx.beginPath();
		ctx.strokeStyle=dlColor;
		ctx.lineWidth=16*sizScale;
		ctx.arc(c.width/2,c.height-58*sizScale,c.height/1.8-ctx.lineWidth,-Math.PI*1.1,(1-(1/(Math.pow(1.3,Math.sqrt(amount)))))*Math.PI*1.2-Math.PI*1.1);
		ctx.stroke();
	}
}

var statusXHR = new XMLHttpRequest(),
	downloadXHR = new XMLHttpRequest();

var startTime = (new Date()).getTime();
var endTime = startTime;
var byteInMegaBit = 1024*1024/8;
downloadXHR.onprogress = function () {
	try {
		endTime = (new Date()).getTime();
		var downloadInMegaBit = downloadXHR.responseText.length / byteInMegaBit;
		var time = (endTime - startTime) / 1000;
		var speed = ((downloadInMegaBit / time)).toFixed(2);
		I("dlText").textContent = speed;
		drawMeter(speed);
	}catch(err) {
		console.error(err);
		downloadXHR.abort();
	}
}
downloadXHR.onreadystatechange = function () {
	if (downloadXHR.readyState == 2)
	{
		I("startStopBtn").className="running";
		startTime = (new Date().getTime());
	}
	if (downloadXHR.readyState == 4)
	{
		//downloadXHR.abort();
		I("startStopBtn").className="";
	}
}

function startStop() {
	if(downloadXHR.readyState <= 1){
		drawMeter(0.00);
		statusXHR.open('GET','/cgi-bin/devzero?getIP', true);
		statusXHR.onload = function load() {
			I('ip').textContent=statusXHR.responseText;
			if(statusXHR.status != 200) return;
			downloadXHR.open('GET','/cgi-bin/devzero?r=' + Math.random(), true);
			downloadXHR.responseType = "application/zip";
			downloadXHR.send();
			setTimeout(downloadXHR.about, 15000);
		};
		statusXHR.send();
	}else{
		I('ip').textContent="";
		downloadXHR.abort();
	}
}

window.onload = function() {
	drawMeter(0.00);
	statusXHR.open('GET','/cgi-bin/devzero?getIP', true);
	statusXHR.onload = function load() {
		I('ip').textContent=statusXHR.responseText;
	};
	statusXHR.send();
}

</script>
</head>
<body>
<h1>HTML5 Speedtest</h1>
<div id="startStopBtn" onclick="startStop()"></div>
<div id="test">
	<div class="testArea">
		<div class="testName">Download</div>
		<canvas id="dlMeter" class="meter"></canvas>
		<div id="dlText" class="meterText"></div>
		<div class="unit">Mbps</div>
	</div>
	<div id="ipArea">
		IP Address: <span id="ip"></span>
	</div>
</div>

</body>
</html>
